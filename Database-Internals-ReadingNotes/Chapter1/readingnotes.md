

数据库系统主要模块：

* 接受请求的传输层
* 决定以最高效方式运行查询的查询处理器
* 执行操作的执行引擎
* 存储引擎

## 简介与概述

* OLTP 联机事务分析

* OLAP 联机分析处理

处理复杂的聚合，OLAP数据库通常用于分析和数据仓库，能够处理复杂的长时间运行的ad-hoc查询

* HTAP 混合事务和分析处理

## 内存数据库与磁盘数据库

内存数据库：

主要数据存储在内存，使用磁盘进行数据恢复和日志记录

磁盘数据库：

大部分数据在磁盘，内存用于缓存磁盘内容

### 基于内存存储的持久性

数据库在认定某个操作完成之前，必须将其结果写入一个顺序日志文件。也就是pre-commit log.

同时为了避免在启动过程中或者崩溃恢复后重放完整的日志内容，内存数据库还会维护一个备份副本。并且结合快照机制，每隔一段时间生成一个checkpoint,备份将会持有截止到这一特定时间点的数据库快照，之前的内容都会被丢弃。那么重放日志的时候，无需重放完整的内容，只需要从checkpoint开始重启就行了。

同时修改日志通常是**异步**，避免了备份过程对客户端请求的阻塞。

## 行存储与列存储

在一次读取中，同一列读取多个值可以显著提高缓存利用率和计算效率。

SIMD有了用武之地，SIMD能够在一个CPU周期内同时对多列数据执行相同的指令。

同时，相同数据类型的值存储在一起也有利于提高压缩率，例如数字和数字存储在一起，字符串和字符串连接在一起，针对不同情况采取不同的压缩算法。

### 宽列式存储

数据表现为多维映射

列被分组为列族，列族单独存储，每个列族中同一key数据是按行存储。

## 数据文件与索引文件

数据库系统常把数据文件和索引文件分开

* 数据文件 存储数据记录

可以细分为以下几种：

1.索引组织

数据记录存储在索引自身，记录是按照键顺序存储的，所以比较适合用于**范围扫描**。



2.堆组织

按写顺序放置。

堆文件需要额外的索引结构来指向存储数据记录的位置。



3.哈希组织

拉链法，记录存储在桶中，按照Key的Hash值确定记录所在的桶，然后存储在桶中的记录可以按照追加顺序存储，也可以按照键排序顺序存储来提高查找速度。



* 索引文件 存储元数据，用于定位数据文件中的记录

索引文件通常组织成页，每个页通常有单个或者多个磁盘块的大小，页可以被组织成记录的序列或者是分槽页

通常在删除记录的时候，不显式删除元数据，而是用删除标记(tombstone)，这个标记包含**这个删除动作的元数据，如键和时间戳**



**主索引**

基于主键或者作为主键的一组键上的构建的，所有其他索引都是二级索引。



**二级索引**

建立在其他键上的索引都是二级索引。

二级索引可以直接指向数据记录，也可以简单存储其主键。多个二级索引可以同时指向同一记录。

如果数据记录的顺序按照搜索键排序，这种索引为**聚簇索引**（索引中存放顺序与物理存储中存放顺序一致）。

如果文件保留了key的顺序，而数据存储在单独的文件中，顺序不遵循键顺序，索引被称为**非聚簇索引**，可以理解为非聚簇索引是存储了数据的偏移量。

主索引通常是聚簇的，而二级索引一定不是聚簇的，因为其用于加速主键以外的Key的访问。



**间接主索引**

* 直接通过文件偏移量引用

通过直接引用数据，可以减少查找磁盘的次数，在维护过程中需要更新或者重定位记录的时候却需要承担更新指针所带来的成本。

* 通过主键索引间接引用

首先查二级索引，然后查得其在主索引的偏移量。

通过主键索引间接引用，读取路径成本更高，但是可以减少指针维护的开销。



**缓冲，不可变与有序性**

缓冲：

数据写磁盘之前是否放在缓存中

可变与不可变：

追加和修改实现的方式。

有序性：

数据键记录是否按照顺序存储在磁盘的页中

